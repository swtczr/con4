<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nardello — чат интерфейс</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#0d0f12; --panel:#111418; --elev:#151a20; --text:#e6e8eb; --muted:#a4acb8; --border:#20262e; --accent:#18a957; --accent-strong:#13914a; --code:#0b0f14; --user:#1f2937; --assistant:#0f1720; --radius:14px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .app{ display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr auto; grid-template-areas:"sidebar header" "sidebar main" "sidebar composer"; height:100dvh; }
    .sidebar{ grid-area:sidebar; border-right:1px solid var(--border); background:var(--panel); display:flex; flex-direction:column; min-width:240px; }
    .brand{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
    .badge{ display:inline-block; padding:8px 12px; border-radius:999px; background:var(--accent); color:#fff; font-weight:700; letter-spacing:.2px; font-size:14px; }
    .brand small{ color:var(--muted); margin-left:auto; font-size:12px; opacity:.9; }
    .side-actions{ padding:12px 12px 0; }
    .btn{ width:100%; background:var(--elev); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-weight:600; cursor:pointer; }
    .btn:hover{border-color:#2a323c}
    .history{ padding:8px 8px 16px; overflow:auto; }
    .chat-item{ display:block; border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin:8px 4px; color:var(--text); background:transparent; text-decoration:none; font-size:14px; line-height:1.25; }
    .chat-item:hover{background:#0e1217;border-color:#2a323c}
    .chat-item time{ display:block; color:var(--muted); font-size:11px; margin-top:6px }
    .header{ grid-area:header; border-bottom:1px solid var(--border); background:linear-gradient(180deg, #0e1216 0%, #0d0f12 100%); display:flex; align-items:center; gap:10px; padding:10px 16px; }
    .header h1{ margin:0; font-size:14px; font-weight:600; color:var(--muted); }
    .status-dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 3px rgba(24,169,87,.15); }
    .main{ grid-area:main; overflow:auto; padding:18px 0; scroll-behavior:smooth; }
    .container{max-width:940px; margin:0 auto; padding:0 16px}
    .msg{ display:grid; grid-template-columns:40px 1fr; gap:12px; padding:10px 12px; }
    .avatar{ width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:#0b1016; color:#9bb3ff; font-weight:700; border:1px solid var(--border); user-select:none; }
    .role-user .avatar{background:#121a24; color:#cfe1ff}
    .bubble{ background:var(--assistant); border:1px solid var(--border); border-radius:14px; padding:14px 14px; line-height:1.55; font-size:15px; overflow:hidden; }
    .role-user .bubble{background:var(--user)}
    .bubble p{margin:0 0 10px} .bubble p:last-child{margin:0}
    .meta{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px; margin-top:8px; }
    .msg + .msg{margin-top:2px}
    pre{ background:var(--code); border:1px dashed #263040; padding:12px; border-radius:12px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:13px; line-height:1.5; }
    .bubble a{color:#93cfff; text-decoration:none}
    .bubble a:hover{text-decoration:underline}
    .bubble figure{margin:8px 0; display:inline-block}
    .bubble img{ max-width:100%; border-radius:12px; border:1px solid var(--border); display:block; }
    .bubble figcaption{ color:var(--muted); font-size:12px; margin-top:6px; }
    .composer{ grid-area:composer; border-top:1px solid var(--border); background:var(--bg); }
    .composer-inner{ max-width:940px; margin:10px auto; padding:0 16px 14px; }
    .input-wrap{ display:flex; gap:10px; align-items:flex-end; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px; }
    textarea{ flex:1; resize:none; min-height:48px; max-height:220px; background:transparent; border:none; outline:none; color:var(--text); font: 500 15px/1.5 Inter, system-ui; }
    .send{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--accent); color:#fff; font-weight:700; cursor:pointer; }
    .send:hover{background:var(--accent-strong)}
    .hint{ margin-top:8px; color:var(--muted); font-size:12px; }
    @media (max-width: 880px){
      .app{ grid-template-columns:1fr; grid-template-areas:"header" "main" "composer"; }
      .sidebar{display:none} .container, .composer-inner{max-width:760px}
    }
    .btn:focus, .send:focus, .chat-item:focus, textarea:focus{outline:2px solid #2c7; outline-offset:2px}
  </style>
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar" aria-label="Боковая панель">
      <div class="brand">
        <span class="badge" style="font-weight:700">Nardello</span>
        <small>v0.1</small>
      </div>
      <div class="side-actions">
        <button class="btn" id="newChatBtn" type="button">+ Новый чат</button>
      </div>
      <nav class="history" aria-label="История чатов">
        <a class="chat-item" href="#" data-load="welcome">Добро пожаловать в Nardello<time>сегодня</time></a>
        <a class="chat-item" href="#" data-load="demo">Демонстрация интерфейса<time>сегодня</time></a>
      </nav>
    </aside>

    <header class="header" aria-label="Заголовок">
      <span class="status-dot" aria-hidden="true"></span>
      <h1>Чат • Nardello</h1>
    </header>

    <main class="main" id="main" aria-live="polite">
      <div class="container" id="messages">
        <section class="msg role-assistant" aria-label="Сообщение ассистента">
          <div class="avatar" aria-hidden="true">AI</div>
          <div class="content">
            <div class="bubble">
              <p>Здравствуйте! Это демо-интерфейс чата <strong>Nardello</strong> с тёмной темой. Напишите сообщение ниже — отправка по <kbd>Ctrl/⌘ + Enter</kbd>.</p>
              <pre><code>// Подсказка:
Shift + Enter — новая строка
Ctrl/⌘ + Enter — отправить</code></pre>
            </div>
            <div class="meta"><span>Ассистент</span><time>сейчас</time></div>
          </div>
        </section>

        <section class="msg role-user" aria-label="Сообщение пользователя">
          <div class="avatar" aria-hidden="true">U</div>
          <div class="content">
            <div class="bubble">
              <p>Покажи, как выглядят изображения по URL.</p>
              <p>Пример: <a href="https://picsum.photos/800/400" target="_blank" rel="noopener">https://picsum.photos/800/400</a></p>
            </div>
            <div class="meta"><span>Вы</span><time>минуту назад</time></div>
          </div>
        </section>

        <section class="msg role-assistant" aria-label="Сообщение ассистента">
          <div class="avatar" aria-hidden="true">AI</div>
          <div class="content">
            <div class="bubble">
              <p>Ссылки на изображения можно встраивать прямо в сообщение:</p>
              <figure>
                <img src="https://picsum.photos/800/400" alt="Демонстрационное изображение" loading="lazy">
                <figcaption>Демо: загрузка по внешнему URL</figcaption>
              </figure>
            </div>
            <div class="meta"><span>Ассистент</span><time>только что</time></div>
          </div>
        </section>
      </div>
    </main>

    <footer class="composer" aria-label="Поле ввода">
      <div class="composer-inner">
        <div class="input-wrap">
          <textarea id="input" rows="1" placeholder="Напишите сообщение…"
            aria-label="Сообщение (Shift+Enter — новая строка, Ctrl/⌘+Enter — отправка)"></textarea>
          <button class="send" id="sendBtn" type="button" aria-label="Отправить сообщение">Отправить</button>
        </div>
        <div class="hint">Shift+Enter — новая строка · Ctrl/⌘+Enter — отправить</div>
      </div>
    </footer>
  </div>

  <script>
    const CHAT_ENDPOINT = "/api/chat"; // серверless-функция на Vercel

    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');
    const main = document.getElementById('main');

    function escapeHtml(str){ return String(str)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    function autolink(text){
      const urlRe = /\b(https?:\/\/[^\s<]+)\b/gi;
      return text.replace(urlRe, (m)=>`<a href="${m}" target="_blank" rel="noopener">${escapeHtml(m)}</a>`);
    }

    function embedImages(html){
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      tmp.querySelectorAll('a[href]').forEach(a=>{
        const href = a.getAttribute('href');
        if (/(\.png|jpe?g|gif|webp|avif|svg)(\?.*)?$/i.test(href) || /picsum\.photos\/\d+/i.test(href)){
          const fig = document.createElement('figure');
          const img = document.createElement('img'); img.src = href; img.loading='lazy'; img.alt='Изображение по ссылке';
          const cap = document.createElement('figcaption'); cap.textContent = href;
          fig.appendChild(img); fig.appendChild(cap); a.replaceWith(fig);
        }
      });
      return tmp.innerHTML;
    }

    function addMessage(role, html){
      const section = document.createElement('section');
      section.className = `msg role-${role}`;
      section.setAttribute('aria-label', role === 'user' ? 'Сообщение пользователя' : 'Сообщение ассистента');
      section.innerHTML = `
        <div class="avatar" aria-hidden="true">${role==='user'?'U':'AI'}</div>
        <div class="content">
          <div class="bubble">${html}</div>
          <div class="meta">
            <span>${role==='user'?'Вы':'Ассистент'}</span>
            <time>${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</time>
          </div>
        </div>`;
      messages.appendChild(section);
      requestAnimationFrame(()=>{ main.scrollTop = main.scrollHeight; });
    }

    function setThinking(){
      const id = 'thinking-' + Math.random().toString(36).slice(2);
      addMessage('assistant', `<em id="${id}" style="color:#a4acb8">Обработка…</em>`);
      return id;
    }
    function replaceThinking(id, html){
      const el = document.getElementById(id);
      if(el){ el.closest('.bubble').innerHTML = html; } else { addMessage('assistant', html); }
    }

    async function sendMessage(){
      const raw = input.value.trim();
      if(!raw) return;

      const html = embedImages(autolink(escapeHtml(raw)).replace(/\n/g,'<br>'));
      addMessage('user', html);
      input.value=''; input.style.height='auto';

      const thinkingId = setThinking();

      try{
        // Сценарий ожидает поле "code"
        const resp = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: raw })
        });
        let data=null; try{ data = await resp.json(); }catch(_){}

        if(resp.ok && data){
          if (data.status === "ok"){
            const title = escapeHtml(data.documentTitle ?? 'Документ');
            const text  = escapeHtml(data.documentContent ?? '').replace(/\n/g,'<br>');
            const link  = data.sourceLink ? `<div class="hint" style="margin-top:10px"><a href="https://docs.google.com/document/d/${encodeURIComponent(String(data.sourceLink))}" target="_blank" rel="noopener">Открыть источник</a></div>` : '';
            replaceThinking(thinkingId, `<strong>${title}</strong><br>${text}${link}`);
          } else {
            const msg = escapeHtml(String(data.message ?? 'Нет данных'));
            const content = escapeHtml(String(data.content ?? ''));
            replaceThinking(thinkingId, `⚠️ ${msg}<br><br><small style="color:#a4acb8">${content}</small>`);
          }
        } else {
          replaceThinking(thinkingId, `⚠️ Ошибка сервера: ${resp.status} ${escapeHtml(resp.statusText || '')}`);
        }
      }catch(err){
        replaceThinking(thinkingId, `⚠️ Сетевая ошибка: ${escapeHtml(err?.message || String(err))}`);
      }
    }

    input.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('input', ()=>{ input.style.height='auto'; input.style.height=Math.min(input.scrollHeight,220)+'px'; });

    document.getElementById('newChatBtn').addEventListener('click', ()=>{
      document.getElementById('messages').innerHTML='';
      addMessage('assistant','<p>Новый чат Nardello. Чем могу помочь?</p>');
    });
    document.querySelectorAll('.chat-item').forEach(item=>{
      item.addEventListener('click',(e)=>{ e.preventDefault(); document.getElementById('messages').innerHTML=''; addMessage('assistant','<p>Загружен сохранённый чат. Продолжайте общение.</p>'); });
    });
  </script>
</body>
</html>